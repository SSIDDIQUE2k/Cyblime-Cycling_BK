{% extends 'base.html' %}
{% load static %}

{% block title %}Strava - Cyblime-Cycling Club{% endblock %}

{% block extra_css %}
<style>
    /* Full-height Strava page with navbar */
    body {
        overflow: hidden;
    }
    
    main {
        padding-top: 64px; /* Account for fixed navbar */
        height: 100vh;
        overflow: hidden;
    }
    
    /* Full iframe below navbar */
    .strava-container {
        position: relative;
        width: 100%;
        height: calc(100vh - 64px); /* Full height minus navbar */
        background: #FC4C02;
    }
    
    .fullscreen-iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }
    
    /* Loading screen */
    .loading-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #FC4C02 0%, #FF7A00 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        z-index: 1000;
        transition: opacity 0.5s ease-out;
    }
    
    .loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .loading-logo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-bottom: 1.5rem;
        animation: pulse 2s infinite;
    }
    
    .loading-title {
        font-size: 2rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
        text-align: center;
    }
    
    .loading-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .fallback-message {
        text-align: center;
        max-width: 400px;
        padding: 0 1rem;
    }
    
    .fallback-button {
        display: inline-block;
        background: white;
        color: #FC4C02;
        padding: 12px 24px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: bold;
        font-size: 1rem;
        margin-top: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .fallback-button:hover {
        background: #f0f0f0;
        transform: scale(1.05);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        main {
            padding-top: 64px;
        }
        
        .strava-container {
            height: calc(100vh - 64px);
        }
        
        .loading-title {
            font-size: 1.5rem;
        }
        
        .loading-subtitle {
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="strava-container">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <img src="{% static 'images/cyblime-cycling-logo.png' %}" alt="Cyblime-Cycling" class="loading-logo">
        <h1 class="loading-title">CYBLIME CYCLING</h1>
        <p class="loading-subtitle">Loading Strava Club...</p>
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Full-Screen Strava Iframe -->
    <iframe 
        id="stravaFrame"
        class="fullscreen-iframe"
        src="https://www.strava.com/clubs/762372"
        title="Cyblime Cycling Club - Full Strava Experience"
        loading="lazy"
        allowfullscreen>
    </iframe>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle iframe loading
    const iframe = document.getElementById('stravaFrame');
    const loadingScreen = document.getElementById('loadingScreen');
    let loadingTimeout;
    let fallbackShown = false;
    
    // Show loading for minimum 2 seconds for better UX
    const minimumLoadingTime = 2000;
    const maxLoadingTime = 15000; // 15 seconds max
    
    const startTime = Date.now();
    
    function hideLoading() {
        const elapsedTime = Date.now() - startTime;
        const remainingTime = Math.max(0, minimumLoadingTime - elapsedTime);
        
        setTimeout(() => {
            loadingScreen.classList.add('hidden');
            // Remove loading screen completely after animation
            setTimeout(() => {
                if (loadingScreen.parentNode) {
                    loadingScreen.remove();
                }
            }, 500);
        }, remainingTime);
    }
    
    function showFallback() {
        if (fallbackShown) return;
        fallbackShown = true;
        
        loadingScreen.innerHTML = `
            <img src="{% static 'images/cyblime-cycling-logo.png' %}" alt="Cyblime-Cycling" class="loading-logo">
            <h1 class="loading-title">CYBLIME CYCLING</h1>
            <div class="fallback-message">
                <p class="loading-subtitle">Unable to load Strava embed</p>
                <p style="opacity: 0.8; margin-bottom: 1rem;">Visit our Strava club directly for the full experience:</p>
                <a href="https://www.strava.com/clubs/762372" target="_blank" class="fallback-button">
                    ðŸš´ Open Strava Club 762372
                </a>
                <p style="opacity: 0.6; margin-top: 1rem; font-size: 0.9rem;">
                    You can also try refreshing this page
                </p>
            </div>
        `;
    }
    
    // Set maximum loading timeout
    loadingTimeout = setTimeout(() => {
        showFallback();
    }, maxLoadingTime);
    
    // Handle successful iframe load
    iframe.addEventListener('load', function() {
        clearTimeout(loadingTimeout);
        console.log('Strava club loaded successfully');
        hideLoading();
    });
    
    // Handle iframe error
    iframe.addEventListener('error', function() {
        clearTimeout(loadingTimeout);
        console.error('Failed to load Strava club');
        showFallback();
    });
    
    // Fallback for when iframe content blocks loading events
    setTimeout(() => {
        // If we can interact with iframe content, assume it loaded
        try {
            if (iframe.contentWindow || iframe.contentDocument) {
                clearTimeout(loadingTimeout);
                hideLoading();
            }
        } catch(e) {
            // Cross-origin restrictions prevent access, but iframe might be loaded
            // This is normal for Strava, so we'll hide loading after minimum time
            clearTimeout(loadingTimeout);
            setTimeout(hideLoading, minimumLoadingTime);
        }
    }, 3000);
    
    // Handle visibility change (when user comes back to tab)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && fallbackShown) {
            // User came back to tab and we're showing fallback, try to reload
            const retryButton = document.createElement('button');
            retryButton.textContent = 'ðŸ”„ Retry Loading';
            retryButton.className = 'fallback-button';
            retryButton.style.marginLeft = '1rem';
            retryButton.onclick = () => location.reload();
            
            const fallbackMessage = document.querySelector('.fallback-message');
            if (fallbackMessage && !document.querySelector('button')) {
                fallbackMessage.appendChild(retryButton);
            }
        }
    });
</script>
{% endblock %}
