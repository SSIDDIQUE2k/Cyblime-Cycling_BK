{% extends 'base.html' %}
{% load static %}

{% block title %}Store - Cyblime-Cycling Club{% endblock %}

{% block extra_css %}
<style>
    /* Full-height Store page with navbar */
    body {
        overflow: hidden;
    }
    
    main {
        padding-top: 64px; /* Account for fixed navbar */
        height: 100vh;
        overflow: hidden;
    }
    
    /* Full iframe below navbar */
    .store-container {
        position: relative;
        width: 100%;
        height: calc(100vh - 64px); /* Full height minus navbar */
        background: #1f2937; /* Voler dark theme */
    }
    
    .fullscreen-iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }
    
    /* Loading screen */
    .loading-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        z-index: 1000;
        transition: opacity 0.5s ease-out;
    }
    
    .loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .loading-logo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-bottom: 1.5rem;
        animation: pulse 2s infinite;
    }
    
    .loading-title {
        font-size: 2rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
        text-align: center;
    }
    
    .loading-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .fallback-message {
        text-align: center;
        max-width: 400px;
        padding: 0 1rem;
    }
    
    .fallback-button {
        display: inline-block;
        background: white;
        color: #1f2937;
        padding: 12px 24px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: bold;
        font-size: 1rem;
        margin-top: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .fallback-button:hover {
        background: #f0f0f0;
        transform: scale(1.05);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        main {
            padding-top: 64px;
        }
        
        .store-container {
            height: calc(100vh - 64px);
        }
        
        .loading-title {
            font-size: 1.5rem;
        }
        
        .loading-subtitle {
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="store-container">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <img src="{% static 'images/cyblime-cycling-logo.png' %}" alt="Cyblime-Cycling" class="loading-logo">
        <h1 class="loading-title">CYBLIME STORE</h1>
        <p class="loading-subtitle">Loading Custom Cycling Gear...</p>
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Full-Screen Store Iframe -->
    <iframe 
        id="storeFrame"
        class="fullscreen-iframe"
        src="https://www.voler.com/browse/cat2/?cat=grp&store=53255"
        title="Cyblime Cycling Club - Custom Cycling Gear Store"
        loading="lazy"
        allowfullscreen>
    </iframe>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle iframe loading
    const iframe = document.getElementById('storeFrame');
    const loadingScreen = document.getElementById('loadingScreen');
    let loadingTimeout;
    let fallbackShown = false;
    
    // Show loading for minimum 2 seconds for better UX
    const minimumLoadingTime = 2000;
    const maxLoadingTime = 15000; // 15 seconds max
    
    const startTime = Date.now();
    
    // Listen for CSP violations (immediate detection)
    document.addEventListener('securitypolicyviolation', function(e) {
        if (e.violatedDirective === 'frame-ancestors' && e.blockedURI.includes('voler.com')) {
            console.log('CSP frame-ancestors violation detected for Voler.com');
            clearTimeout(loadingTimeout);
            showFallback();
        }
    });
    
    function hideLoading() {
        const elapsedTime = Date.now() - startTime;
        const remainingTime = Math.max(0, minimumLoadingTime - elapsedTime);
        
        setTimeout(() => {
            loadingScreen.classList.add('hidden');
            // Remove loading screen completely after animation
            setTimeout(() => {
                if (loadingScreen.parentNode) {
                    loadingScreen.remove();
                }
            }, 500);
        }, remainingTime);
    }
    
    function showFallback() {
        if (fallbackShown) return;
        fallbackShown = true;
        
        loadingScreen.innerHTML = `
            <img src="{% static 'images/cyblime-cycling-logo.png' %}" alt="Cyblime-Cycling" class="loading-logo">
            <h1 class="loading-title">CYBLIME STORE</h1>
            <div class="fallback-message">
                <p class="loading-subtitle">Store Embed Blocked</p>
                <p style="opacity: 0.8; margin-bottom: 1rem;">Voler.com prevents embedding for security. Visit our store directly:</p>
                <a href="https://www.voler.com/browse/cat2/?cat=grp&store=53255" target="_blank" class="fallback-button">
                    üõçÔ∏è Shop Cyblime Gear
                </a>
                <p style="opacity: 0.6; margin-top: 1rem; font-size: 0.9rem;">
                    Custom jerseys, shorts, and cycling apparel
                </p>
                <p style="opacity: 0.6; margin-top: 0.5rem; font-size: 0.8rem;">
                    You can also try refreshing this page
                </p>
            </div>
        `;
    }
    
    // Set maximum loading timeout
    loadingTimeout = setTimeout(() => {
        showFallback();
    }, maxLoadingTime);
    
    // Handle successful iframe load
    iframe.addEventListener('load', function() {
        clearTimeout(loadingTimeout);
        console.log('Voler store loaded successfully');
        hideLoading();
    });
    
    // Handle iframe error
    iframe.addEventListener('error', function() {
        clearTimeout(loadingTimeout);
        console.error('Failed to load Voler store');
        showFallback();
    });
    
    // Enhanced CSP detection for Voler store
    // Since Voler blocks iframe embedding with CSP frame-ancestors 'self',
    // we detect this quickly and show fallback
    
    let cspCheckAttempts = 0;
    const maxCspChecks = 3;
    
    function checkForCSPBlocking() {
        cspCheckAttempts++;
        
        try {
            // Try to access iframe content - this will fail if CSP blocks it
            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
            
            if (!iframeDoc) {
                // Cannot access iframe content, likely CSP blocked
                console.log('CSP restriction detected - cannot access iframe content');
                clearTimeout(loadingTimeout);
                showFallback();
                return;
            }
            
            // Check if iframe loaded successfully
            if (iframe.contentWindow && iframe.contentWindow.location) {
                console.log('Voler store loaded successfully');
                clearTimeout(loadingTimeout);
                hideLoading();
                return;
            }
        } catch(e) {
            // CSP error or cross-origin restriction detected
            console.log('CSP/Cross-origin restriction detected:', e.message);
            clearTimeout(loadingTimeout);
            showFallback();
            return;
        }
        
        // If we haven't detected success or failure yet, try again
        if (cspCheckAttempts < maxCspChecks) {
            setTimeout(checkForCSPBlocking, 1500);
        } else {
            // Max attempts reached, assume blocking
            console.log('Max CSP check attempts reached, assuming blocked');
            clearTimeout(loadingTimeout);
            showFallback();
        }
    }
    
    // Start CSP detection after a short delay
    setTimeout(checkForCSPBlocking, 1000);
    
    // Handle visibility change (when user comes back to tab)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && fallbackShown) {
            // User came back to tab and we're showing fallback, try to reload
            const retryButton = document.createElement('button');
            retryButton.textContent = 'üîÑ Retry Loading';
            retryButton.className = 'fallback-button';
            retryButton.style.marginLeft = '1rem';
            retryButton.onclick = () => location.reload();
            
            const fallbackMessage = document.querySelector('.fallback-message');
            if (fallbackMessage && !document.querySelector('button')) {
                fallbackMessage.appendChild(retryButton);
            }
        }
    });
</script>
{% endblock %}
